<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Family First Therapeutic Outing Scheduler</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f5f5f5;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        h1 {
            color: #2c3e50;
            margin-bottom: 30px;
            text-align: center;
        }

        .card {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 20px;
            margin-bottom: 20px;
        }

        .card h2 {
            color: #34495e;
            margin-bottom: 15px;
            font-size: 1.5em;
        }

        .button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }

        .button:hover {
            background-color: #2980b9;
        }

        .button.success {
            background-color: #27ae60;
        }

        .button.success:hover {
            background-color: #229954;
        }

        .button.danger {
            background-color: #e74c3c;
        }

        .button.danger:hover {
            background-color: #c0392b;
        }

        .schedule-grid {
            display: grid;
            grid-template-columns: 150px repeat(6, 1fr);
            gap: 1px;
            background-color: #ddd;
            margin-top: 20px;
            border: 1px solid #ddd;
        }

        .schedule-header {
            background-color: #34495e;
            color: white;
            padding: 10px;
            font-weight: bold;
            text-align: center;
        }

        .schedule-date {
            background-color: #ecf0f1;
            padding: 10px;
            font-weight: bold;
        }

        .schedule-cell {
            background-color: white;
            padding: 10px;
            min-height: 80px;
        }

        .vendor-name {
            font-weight: bold;
            color: #2c3e50;
        }

        .vendor-time {
            font-size: 0.9em;
            color: #7f8c8d;
            margin-top: 5px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #555;
            font-weight: 500;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .alert {
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }

        .alert.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            display: inline-block;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .color-indicator {
            display: inline-block;
            width: 20px;
            height: 20px;
            border-radius: 3px;
            margin-right: 5px;
            vertical-align: middle;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Family First Therapeutic Outing Scheduler</h1>

        <div id="alerts"></div>

        <div class="card">
            <h2>Quick Actions</h2>
            <div class="actions">
                <button class="button success" onclick="generateYearSchedule()">
                    Generate Year Schedule
                </button>
                <button class="button" onclick="loadCurrentWeek()">
                    View Current Week
                </button>
                <button class="button" onclick="downloadPDF()">
                    Download PDF
                </button>
                <button class="button" onclick="syncGoogleSheets()">
                    Sync to Google Sheets
                </button>
                <button class="button" onclick="sendNotifications()">
                    Send Email Notifications
                </button>
            </div>
        </div>

        <div class="card">
            <h2>Schedule for <span id="currentDate">Loading...</span></h2>
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>Loading schedule...</p>
            </div>
            <div id="scheduleView"></div>
        </div>

        <div class="card">
            <h2>Programs</h2>
            <div id="programsList"></div>
        </div>

        <div class="card">
            <h2>Vendors</h2>
            <div id="vendorsList"></div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:3000/api/v1';
        let currentDate = getNextTuesday();

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadCurrentWeek();
            loadPrograms();
            loadVendors();
        });

        function getNextTuesday() {
            const today = new Date();
            const dayOfWeek = today.getDay();
            const daysUntilTuesday = (2 - dayOfWeek + 7) % 7 || 7;
            const nextTuesday = new Date(today);
            nextTuesday.setDate(today.getDate() + daysUntilTuesday);
            return nextTuesday.toISOString().split('T')[0];
        }

        function showAlert(message, type = 'success') {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert ${type}`;
            alertDiv.textContent = message;
            
            const alertsContainer = document.getElementById('alerts');
            alertsContainer.appendChild(alertDiv);
            
            setTimeout(() => {
                alertDiv.remove();
            }, 5000);
        }

        function showLoading() {
            document.getElementById('loading').style.display = 'block';
        }

        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
        }

        async function loadCurrentWeek() {
            showLoading();
            try {
                const response = await fetch(`${API_BASE}/advanced-schedules/${currentDate}/details`);
                const data = await response.json();
                
                document.getElementById('currentDate').textContent = 
                    new Date(currentDate).toLocaleDateString('en-US', {
                        weekday: 'long',
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric'
                    });
                
                displaySchedule(data);
            } catch (error) {
                showAlert('Error loading schedule: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        function displaySchedule(scheduleData) {
            const scheduleView = document.getElementById('scheduleView');
            
            let html = '<div class="schedule-grid">';
            
            // Header row
            html += '<div class="schedule-header">Time</div>';
            const programs = ['Banyan', 'Hedge', 'Preserve', 'Cove', 'Meridian', 'Prosperity'];
            programs.forEach(program => {
                const programData = scheduleData.programs.find(p => p.house_name === program);
                const color = programData?.color || '#ccc';
                html += `<div class="schedule-header">
                    <span class="color-indicator" style="background-color: ${color}"></span>
                    ${program}
                </div>`;
            });
            
            // Schedule data
            html += '<div class="schedule-date">Outings</div>';
            programs.forEach(program => {
                const assignment = scheduleData.assignments[program];
                if (assignment) {
                    const cellStyle = assignment.color ? `background-color: ${assignment.color}20;` : '';
                    html += `<div class="schedule-cell" style="${cellStyle}">
                        <div class="vendor-name">${assignment.vendor}</div>
                        <div class="vendor-time">${assignment.time}</div>
                        ${assignment.address ? `<div style="font-size: 0.8em; margin-top: 5px;">üìç ${assignment.address}</div>` : ''}
                    </div>`;
                } else {
                    html += '<div class="schedule-cell">TBD</div>';
                }
            });
            
            html += '</div>';
            
            // Outing expectations
            if (scheduleData.expectations && scheduleData.expectations.length > 0) {
                html += '<div style="margin-top: 20px;">';
                html += '<h3>Outing Expectations</h3>';
                scheduleData.expectations.forEach(exp => {
                    html += `<div style="margin-top: 10px; padding: 15px; background-color: #f8f9fa; border-radius: 5px;">
                        <h4>${exp.title}</h4>
                        <div style="white-space: pre-line; margin-top: 10px;">${exp.content}</div>
                    </div>`;
                });
                html += '</div>';
            }
            
            scheduleView.innerHTML = html;
        }

        async function loadPrograms() {
            try {
                const response = await fetch(`${API_BASE}/programs`);
                const programs = await response.json();
                
                const programsList = document.getElementById('programsList');
                let html = '<table style="width: 100%; border-collapse: collapse;">';
                html += '<tr><th>House</th><th>Time</th><th>Coordinator</th></tr>';
                
                programs.forEach(program => {
                    html += `<tr style="border-bottom: 1px solid #eee;">
                        <td style="padding: 10px;">
                            <span class="color-indicator" style="background-color: ${program.color}"></span>
                            ${program.house_name}
                        </td>
                        <td>${program.tuesday_start} - ${program.tuesday_end}</td>
                        <td>${program.program_coordinator_email || 'Not set'}</td>
                    </tr>`;
                });
                
                html += '</table>';
                programsList.innerHTML = html;
            } catch (error) {
                console.error('Error loading programs:', error);
            }
        }

        async function loadVendors() {
            try {
                const response = await fetch(`${API_BASE}/vendors`);
                const vendors = await response.json();
                
                const vendorsList = document.getElementById('vendorsList');
                let html = '<table style="width: 100%; border-collapse: collapse;">';
                html += '<tr><th>Vendor</th><th>Type</th><th>Contact</th><th>Rotation</th></tr>';
                
                vendors.filter(v => v.active).forEach(vendor => {
                    html += `<tr style="border-bottom: 1px solid #eee;">
                        <td style="padding: 10px;">
                            <span class="color-indicator" style="background-color: ${vendor.color || '#ccc'}"></span>
                            ${vendor.name}
                        </td>
                        <td>${vendor.vendor_type || 'N/A'}</td>
                        <td>${vendor.contact || 'N/A'}<br>${vendor.phone || ''}</td>
                        <td>${vendor.is_rotation_vendor ? '‚úì Monthly' : ''}</td>
                    </tr>`;
                });
                
                html += '</table>';
                vendorsList.innerHTML = html;
            } catch (error) {
                console.error('Error loading vendors:', error);
            }
        }

        async function generateYearSchedule() {
            if (!confirm('Generate schedule for the next 52 weeks? This will create schedules starting from next Tuesday.')) {
                return;
            }
            
            showLoading();
            try {
                const response = await fetch(`${API_BASE}/advanced-schedules/generate-year`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        facility_id: 1,
                        start_date: currentDate,
                        weeks: 52
                    })
                });
                
                const data = await response.json();
                showAlert('Successfully generated schedules for 52 weeks!', 'success');
                loadCurrentWeek();
            } catch (error) {
                showAlert('Error generating schedule: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        async function downloadPDF() {
            try {
                window.open(`${API_BASE}/advanced-schedules/${currentDate}/pdf`, '_blank');
            } catch (error) {
                showAlert('Error downloading PDF: ' + error.message, 'error');
            }
        }

        async function syncGoogleSheets() {
            showLoading();
            try {
                const response = await fetch(`${API_BASE}/advanced-schedules/sync-sheets`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        date_range: {
                            start: currentDate,
                            end: new Date(new Date(currentDate).getTime() + 90 * 24 * 60 * 60 * 1000).toISOString().split('T')[0]
                        }
                    })
                });
                
                const data = await response.json();
                if (data.success) {
                    showAlert('Successfully synced to Google Sheets!', 'success');
                    if (data.url) {
                        window.open(data.url, '_blank');
                    }
                } else {
                    showAlert('Error syncing to Google Sheets: ' + data.error, 'error');
                }
            } catch (error) {
                showAlert('Error syncing to Google Sheets: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        async function sendNotifications() {
            if (!confirm('Send email notifications to all program coordinators for this week?')) {
                return;
            }
            
            showLoading();
            try {
                const response = await fetch(`${API_BASE}/advanced-schedules/${currentDate}/notify`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({})
                });
                
                const data = await response.json();
                if (data.success) {
                    showAlert('Email notifications sent successfully!', 'success');
                } else {
                    showAlert('Error sending notifications: ' + data.error, 'error');
                }
            } catch (error) {
                showAlert('Error sending notifications: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }
    </script>
</body>
</html>
